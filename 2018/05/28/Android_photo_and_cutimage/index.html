<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="不知道描述啥"><title>Android 适配7.0拍照、图库、裁剪 | Sing</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android 适配7.0拍照、图库、裁剪</h1><a id="logo" href="/.">Sing</a><p class="description">笔记</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa undefined"> 首页</i></a><a href="/django"><i class="fa undefined"> Django</i></a><a href="/html_css"><i class="fa undefined"> Html_css</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/">JAVA</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySql/">MySql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/教程/">教程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/05/28/Android_photo_and_cutimage/">Android 适配7.0拍照、图库、裁剪</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/18/Linux_install_tomcat/">Linux 环境下安装 Tomcat</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/17/Linux_install_jdk/">Linux 环境下安装 JDK</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/11/Linux_install_mysql/">Linux 环境下安装MySql</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/29/Python_crawler/">用 Python 编写一个简单的爬虫</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/19/Android_CountDownTimer/">CountDownTimer的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/05/Android_decompile/">Android 反编译</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/01/Android_dialog_shadow/">Android 使用Dialog时状态栏变黑的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/21/Python_Django_simple_server/">基于 Python 的简单服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/21/Android_about_image/">Android 图片相关操作</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android 适配7.0拍照、图库、裁剪</h1><div class="post-meta">May 28, 2018<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span></div><div class="post-content"><p>Android在7.0以后传递<code>Uri</code>直接和低版本一样操作会报<code>FileUriExposedException</code>，涉及到了数据共享问题，具体实现：  </p>
<p>首先在<code>AndroidManifest</code>中添加如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">&lt;!--文件共享--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">"android.support.v4.content.FileProvider"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:authorities</span>=<span class="string">"包名.fileprovider"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:exported</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:grantUriPermissions</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">"android.support.FILE_PROVIDER_PATHS"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:resource</span>=<span class="string">"@xml/file_paths"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在属性<code>android:authorities</code>中值填写为<code>包名+fileprovider</code>，然后在<code>meta-data</code>中的<code>resource</code>中对应相关的xml文件，创建该文件并填写内容：  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">external-path</span></span></span><br><span class="line"><span class="tag">        <span class="attr">name</span>=<span class="string">"my_images"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">path</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中</p>
<ul>
<li><files-path> //代表的根目录： Context.getFilesDir()</files-path></li>
<li><external-path> //代表的根目录: Environment.getExternalStorageDirectory()</external-path></li>
<li><cache-path> //代表的根目录: getCacheDir()</cache-path></li>
</ul>
<p>name 可以随便填写，path为共享空间，不填为整个根目录，进入代码模块：  </p>
<p>定义常量：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> TAKE_PHOTO_CODE = <span class="number">1000</span>;<span class="comment">// 拍照</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> SELECT_PHOTO_CODE = <span class="number">1001</span>;<span class="comment">// 图库</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> CUT_PICTURE_CODE = <span class="number">1002</span>;<span class="comment">// 裁剪</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> File file;<span class="comment">// 拍的照片</span></span><br><span class="line"><span class="keyword">private</span> String filePath = Constant.TAKE_PHOTO_PATH;<span class="comment">// 拍照的原图地址</span></span><br><span class="line"><span class="keyword">private</span> File cropFile;<span class="comment">// 剪切后的图片</span></span><br><span class="line"><span class="keyword">private</span> String cropPath = Constant.CUT_PHOTO_PATH;<span class="comment">// 剪切的原图地址</span></span><br></pre></td></tr></table></figure>
<p>然后初始化文件，如果已经存在要删除后在创建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">file = <span class="keyword">new</span> File(filePath);</span><br><span class="line">cropFile = <span class="keyword">new</span> File(cropPath);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">        file.delete();</span><br><span class="line">    &#125;</span><br><span class="line">    file.createNewFile();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cropFile.exists()) &#123;</span><br><span class="line">        cropFile.delete();</span><br><span class="line">    &#125;</span><br><span class="line">    cropFile.createNewFile();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>开始拍照，在拍照之前请检查权限，确认拥有相机权限之后调用如下方法：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent(MediaStore.ACTION_IMAGE_CAPTURE);</span><br><span class="line">Uri temp;</span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">    temp = FileProvider.getUriForFile(ContextHandler.currentActivity(), <span class="string">"包名.fileprovider"</span>, file);<span class="comment">// 一定要对应AndroidMainfast中配置的值</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    temp = Uri.fromFile(file);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 启动相机程序</span></span><br><span class="line">intent.putExtra(MediaStore.Images.Media.ORIENTATION, <span class="number">0</span>);</span><br><span class="line">intent.putExtra(MediaStore.EXTRA_OUTPUT, temp);</span><br><span class="line">startActivityForResult(intent, TAKE_PHOTO_CODE);</span><br></pre></td></tr></table></figure>
<p>调用图库就简单多了：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_PICK, <span class="keyword">null</span>);</span><br><span class="line">intent.setDataAndType(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, <span class="string">"image/*"</span>);</span><br><span class="line">startActivityForResult(intent, SELECT_PHOTO_CODE);</span><br></pre></td></tr></table></figure>
<p>然后是裁剪的方法：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startPhotoZoom</span><span class="params">(Uri uri)</span> </span>&#123;<span class="comment">// 这里的uri也要经过处理</span></span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(<span class="string">"com.android.camera.action.CROP"</span>);</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION); <span class="comment">//添加这一句表示对目标应用临时授权该Uri所代表的文件</span></span><br><span class="line">    &#125;</span><br><span class="line">    intent.setDataAndType(uri, <span class="string">"image/*"</span>);</span><br><span class="line">    <span class="comment">// 下面这个crop=true是设置在开启的Intent中设置显示的VIEW可裁剪</span></span><br><span class="line">    intent.putExtra(<span class="string">"crop"</span>, <span class="string">"true"</span>);</span><br><span class="line">    intent.putExtra(<span class="string">"scale"</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    intent.putExtra(<span class="string">"aspectX"</span>, <span class="number">1</span>);<span class="comment">// 比例</span></span><br><span class="line">    intent.putExtra(<span class="string">"aspectY"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    intent.putExtra(<span class="string">"outputX"</span>, <span class="number">300</span>);<span class="comment">// 输出大小</span></span><br><span class="line">    intent.putExtra(<span class="string">"outputY"</span>, <span class="number">300</span>);</span><br><span class="line"></span><br><span class="line">    intent.putExtra(<span class="string">"return-data"</span>, <span class="keyword">false</span>);</span><br><span class="line">    intent.putExtra(MediaStore.EXTRA_OUTPUT, Uri.fromFile(cropFile));</span><br><span class="line">    intent.putExtra(<span class="string">"outputFormat"</span>, Bitmap.CompressFormat.JPEG.toString());</span><br><span class="line">    intent.putExtra(<span class="string">"noFaceDetection"</span>, <span class="keyword">true</span>); <span class="comment">// no face detection</span></span><br><span class="line">    startActivityForResult(intent, CUT_PICTURE_CODE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拍照、选图、裁图返回来的处理：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onActivityResult(requestCode, resultCode, data);</span><br><span class="line">    <span class="keyword">if</span> (resultCode == Activity.RESULT_OK &amp;&amp; requestCode == TAKE_PHOTO_CODE) &#123;<span class="comment">// 拍照返回</span></span><br><span class="line">        Uri mUri;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;<span class="comment">// 处理uri</span></span><br><span class="line">            mUri = FileProvider.getUriForFile(ContextHandler.currentActivity(), <span class="string">"com.nuhtech.cmedicine.fileprovider"</span>, file);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            mUri = Uri.fromFile(file);</span><br><span class="line">        &#125;</span><br><span class="line">        startPhotoZoom(mUri); <span class="comment">//进行裁剪</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resultCode == Activity.RESULT_OK &amp;&amp; requestCode == SELECT_PHOTO_CODE) &#123;<span class="comment">// 选图返回</span></span><br><span class="line">        <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">            startPhotoZoom(data.getData());<span class="comment">//进行裁剪</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resultCode == Activity.RESULT_OK &amp;&amp; requestCode == CUT_PICTURE_CODE) &#123;<span class="comment">// 裁图返回</span></span><br><span class="line">        <span class="comment">// 现在已经裁剪完毕，根据需求处理结果即可：</span></span><br><span class="line">        <span class="comment">// cropFile 剪切后的图片</span></span><br><span class="line">        <span class="comment">// cropPath 剪切的原图地址</span></span><br><span class="line">        <span class="comment">// 图片上传完成之后记得删除文件</span></span><br><span class="line">        file.delete();</span><br><span class="line">        cropFile.delete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="tags"></div><div class="post-nav"><a class="next" href="/2018/04/18/Linux_install_tomcat/">Linux 环境下安装 Tomcat</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a rel="nofollow" target="_blank" href="http://www.miitbeian.gov.cn/">京ICP备17062560号</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>